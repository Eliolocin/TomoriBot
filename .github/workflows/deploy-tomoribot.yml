name: Deploy TomoriBot
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Stop existing containers
        run: |
          echo "üõë Stopping existing TomoriBot containers..."
          docker-compose down
        continue-on-error: true
        
      - name: Build new image
        run: |
          echo "üèóÔ∏è Building new TomoriBot image..."
          docker-compose build --no-cache
          
      - name: Start updated containers
        run: |
          echo "üöÄ Starting updated TomoriBot..."
          docker-compose up -d
          
      - name: Verify deployment
        run: |
          echo "‚úÖ Verifying TomoriBot is running..."
          Start-Sleep 30
          $containers = docker ps --filter "name=tomoribot" --format "table {{.Names}}\t{{.Status}}"
          echo $containers
          
          # Check if both containers are running
          if ((docker ps --filter "name=tomoribot-app" --filter "status=running" -q) -and 
              (docker ps --filter "name=tomoribot-db" --filter "status=running" -q)) {
            echo "üéâ TomoriBot deployment successful!"
          } else {
            echo "‚ùå TomoriBot deployment failed!"
            exit 1
          }
          
      - name: Discord notification
        if: always()
        run: |
          if ($LASTEXITCODE -eq 0) {
            echo "‚úÖ Would send success notification to Discord"
          } else {
            echo "‚ùå Would send failure notification to Discord"
          }
